<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cesium åœ†å½¢ç»˜åˆ¶å·¥å…· (v1.120) - å¸¦åŠå¾„çº¿å’Œè§’åº¦æ˜¾ç¤º</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
    <style>
      html,
      body,
      #cesiumContainer {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      #toolbar {
        position: absolute;
        top: 15px;
        left: 15px;
        background: rgba(30, 30, 30, 0.85);
        padding: 15px;
        border-radius: 12px;
        z-index: 1000;
        color: white;
        max-width: 320px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      #status {
        margin: 12px 0;
        padding: 10px;
        border-radius: 6px;
        background: rgba(255, 255, 255, 0.08);
        font-size: 14px;
        min-height: 20px;
        display: flex;
        align-items: center;
      }

      .button-group {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }

      button {
        background: linear-gradient(to bottom, #4caf50, #45a049);
        border: none;
        color: white;
        padding: 10px 16px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        border-radius: 6px;
        transition: all 0.3s;
        flex: 1;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        background: linear-gradient(to bottom, #777, #666);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      #clearAll {
        background: linear-gradient(to bottom, #f44336, #d32f2f);
      }

      #clearAll:hover {
        background: linear-gradient(to bottom, #e53935, #c62828);
      }

      h3 {
        margin-top: 0;
        color: #4caf50;
        text-align: center;
        font-size: 18px;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .info {
        font-size: 12px;
        color: #aaa;
        margin-top: 15px;
        line-height: 1.5;
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 6px;
      }

      .radius-info {
        background: rgba(76, 175, 80, 0.2);
        padding: 8px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 13px;
        text-align: center;
        display: none;
      }

      .drawing-active {
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          background-color: rgba(76, 175, 80, 0.2);
        }
        50% {
          background-color: rgba(76, 175, 80, 0.5);
        }
        100% {
          background-color: rgba(76, 175, 80, 0.2);
        }
      }
    </style>
  </head>
  <body>
    <div id="cesiumContainer"></div>
    <div id="toolbar">
      <h3>ğŸŒ Cesium åœ†å½¢ç»˜åˆ¶å·¥å…·</h3>
      <div class="button-group">
        <button id="drawCircle">å¼€å§‹ç»˜åˆ¶åœ†å½¢</button>
        <button id="clearAll">æ¸…é™¤æ‰€æœ‰å›¾å½¢</button>
      </div>
      <div id="status">çŠ¶æ€: ç­‰å¾…å¼€å§‹ç»˜åˆ¶</div>
      <div id="radiusInfo" class="radius-info">åŠå¾„: 0 å…¬é‡Œ | è§’åº¦: 0Â°</div>
      <div class="info">
        <strong>ä½¿ç”¨è¯´æ˜:</strong><br />
        1. ç‚¹å‡»"å¼€å§‹ç»˜åˆ¶åœ†å½¢"æŒ‰é’®<br />
        2. åœ¨åœ°å›¾ä¸Šç‚¹å‡»ç¡®å®šåœ†å¿ƒä½ç½®<br />
        3. æ‹–åŠ¨é¼ æ ‡è°ƒæ•´åœ†çš„åŠå¾„<br />
        4. åŠå¾„çº¿ä¼šå®æ—¶æ˜¾ç¤ºåœ†å¿ƒåˆ°é¼ æ ‡ä½ç½®çš„è·ç¦»å’Œè§’åº¦<br />
        5. å†æ¬¡ç‚¹å‡»å®Œæˆç»˜åˆ¶ï¼ˆä¿ç•™åŠå¾„çº¿å’Œè§’åº¦ä¿¡æ¯ï¼‰
      </div>
    </div>

    <script>
      // è®¾ç½®Cesium Ionè®¿é—®ä»¤ç‰Œï¼ˆéœ€è¦æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„ä»¤ç‰Œï¼‰
      // æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªç¤ºä¾‹ä»¤ç‰Œï¼Œå®é™…ä½¿ç”¨æ—¶éœ€è¦æ›¿æ¢
      Cesium.Ion.defaultAccessToken =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJiOWQxNmQ2ZC1lNzhjLTRlNDQtYmYyZC1kYzk1ZTZiMWQ4NDgiLCJpZCI6Mzc3MjcsImlhdCI6MTYwNTUwNjM5OH0.HCimd3DQp5RxCZ3EqJmlA8WV3rJwtjpBLl0d2wAXfhc";

      // åˆå§‹åŒ–Cesium Viewer
      const viewer = new Cesium.Viewer("cesiumContainer", {
        // terrainProvider: Cesium.createWorldTerrain(),
        animation: false,
        timeline: false,
        homeButton: false,
        geocoder: false,
        baseLayerPicker: false,
        sceneModePicker: false,
        navigationHelpButton: false,
        fullscreenButton: false,
      });

      // è®¾ç½®åˆå§‹è§†å›¾ï¼ˆä¸­å›½åŒºåŸŸï¼‰
      viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(104.0, 36.0, 5000000),
      });

      // ç»˜åˆ¶çŠ¶æ€å˜é‡
      let drawingMode = false;
      let centerPoint = null;
      let temporaryCircle = null;
      let radiusLine = null;
      let handler = null;
      let currentRadius = 0;
      let mousePosition = null;
      let finalRadiusLine = null;
      let radiusLabel = null;

      // è·å–UIå…ƒç´ 
      const drawCircleBtn = document.getElementById("drawCircle");
      const clearAllBtn = document.getElementById("clearAll");
      const statusDiv = document.getElementById("status");
      const radiusInfoDiv = document.getElementById("radiusInfo");

      // å¼€å§‹ç»˜åˆ¶åœ†å½¢
      drawCircleBtn.addEventListener("click", function () {
        if (drawingMode) {
          cancelDrawing();
        } else {
          startDrawing();
        }
      });

      // æ¸…é™¤æ‰€æœ‰å›¾å½¢
      clearAllBtn.addEventListener("click", function () {
        viewer.entities.removeAll();
        statusDiv.textContent = "çŠ¶æ€: å·²æ¸…é™¤æ‰€æœ‰å›¾å½¢";
        radiusInfoDiv.style.display = "none";

        // é‡æ–°æ·»åŠ ç¤ºä¾‹åœ†å½¢
        addExampleCircle();
      });

      // å¼€å§‹ç»˜åˆ¶æ¨¡å¼
      function startDrawing() {
        drawingMode = true;
        drawCircleBtn.textContent = "å–æ¶ˆç»˜åˆ¶";
        drawCircleBtn.classList.add("drawing-active");
        statusDiv.textContent = "çŠ¶æ€: è¯·ç‚¹å‡»åœ°å›¾ç¡®å®šåœ†å¿ƒä½ç½®";
        radiusInfoDiv.style.display = "none";

        // è®¾ç½®äº‹ä»¶å¤„ç†å™¨
        handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

        // ç¬¬ä¸€æ¬¡ç‚¹å‡»ç¡®å®šåœ†å¿ƒ
        handler.setInputAction(function (event) {
          const position = viewer.camera.pickEllipsoid(event.position, viewer.scene.globe.ellipsoid);
          if (position) {
            centerPoint = position;
            statusDiv.textContent = "çŠ¶æ€: æ‹–åŠ¨é¼ æ ‡ç¡®å®šåœ†çš„åŠå¾„ï¼Œç‚¹å‡»å®Œæˆç»˜åˆ¶";
            radiusInfoDiv.style.display = "block";

            // åˆ›å»ºä¸´æ—¶åœ†å½¢
            temporaryCircle = viewer.entities.add({
              position: centerPoint,
              ellipse: {
                semiMinorAxis: new Cesium.CallbackProperty(updateRadius, false),
                semiMajorAxis: new Cesium.CallbackProperty(updateRadius, false),
                material: Cesium.Color.YELLOW.withAlpha(0.4),
                outline: true,
                outlineColor: Cesium.Color.YELLOW,
                outlineWidth: 2,
              },
            });

            // åˆ›å»ºä¸´æ—¶åŠå¾„çº¿
            radiusLine = viewer.entities.add({
              polyline: {
                positions: new Cesium.CallbackProperty(updateLinePositions, false),
                width: 3,
                material: new Cesium.PolylineDashMaterialProperty({
                  color: Cesium.Color.CYAN,
                  dashLength: 16.0,
                }),
              },
            });

            // é¼ æ ‡ç§»åŠ¨æ—¶æ›´æ–°åŠå¾„å’ŒåŠå¾„çº¿
            handler.setInputAction(function (moveEvent) {
              mousePosition = viewer.camera.pickEllipsoid(moveEvent.endPosition, viewer.scene.globe.ellipsoid);
              if (centerPoint && mousePosition) {
                // è®¡ç®—åŠå¾„
                currentRadius = Cesium.Cartesian3.distance(centerPoint, mousePosition);
                // è®¡ç®—ä¸æ­£åŒ—çš„è§’åº¦
                const angle = calculateNorthAngle(centerPoint, mousePosition);
                // æ›´æ–°åŠå¾„ä¿¡æ¯æ˜¾ç¤º
                radiusInfoDiv.textContent = `åŠå¾„: ${(currentRadius / 1000).toFixed(2)} å…¬é‡Œ | è§’åº¦: ${angle.toFixed(1)}Â°`;
              }
            }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

            // ç¬¬äºŒæ¬¡ç‚¹å‡»å®Œæˆç»˜åˆ¶
            handler.setInputAction(function (secondClick) {
              if (centerPoint && temporaryCircle) {
                const finalMousePosition = viewer.camera.pickEllipsoid(secondClick.position, viewer.scene.globe.ellipsoid);
                if (finalMousePosition) {
                  mousePosition = finalMousePosition;
                  currentRadius = Cesium.Cartesian3.distance(centerPoint, mousePosition);
                  const finalAngle = calculateNorthAngle(centerPoint, mousePosition);

                  // ç§»é™¤ä¸´æ—¶åœ†å½¢å’ŒåŠå¾„çº¿
                  viewer.entities.remove(temporaryCircle);
                  viewer.entities.remove(radiusLine);

                  // åˆ›å»ºæœ€ç»ˆåœ†å½¢
                  viewer.entities.add({
                    position: centerPoint,
                    name: "ç»˜åˆ¶çš„åœ†å½¢",
                    ellipse: {
                      semiMinorAxis: currentRadius,
                      semiMajorAxis: currentRadius,
                      material: Cesium.Color.GREEN.withAlpha(0.4),
                      outline: true,
                      outlineColor: Cesium.Color.GREEN,
                      outlineWidth: 3,
                    },
                    description: `åœ†å½¢åŠå¾„: ${(currentRadius / 1000).toFixed(2)} å…¬é‡Œ`,
                  });

                  // åˆ›å»ºæœ€ç»ˆçš„åŠå¾„çº¿ï¼ˆä¿ç•™ï¼‰
                  finalRadiusLine = viewer.entities.add({
                    polyline: {
                      positions: [centerPoint, mousePosition],
                      width: 3,
                      material: Cesium.Color.CYAN,
                    },
                  });

                  // åœ¨åŠå¾„çº¿ç»ˆç‚¹æ·»åŠ åŠå¾„å’Œè§’åº¦æ ‡æ³¨
                  radiusLabel = viewer.entities.add({
                    position: mousePosition,
                    label: {
                      text: `åŠå¾„: ${(currentRadius / 1000).toFixed(2)} km\nè§’åº¦: ${finalAngle.toFixed(1)}Â°`,
                      font: "14pt sans-serif",
                      fillColor: Cesium.Color.WHITE,
                      backgroundColor: Cesium.Color.BLACK.withAlpha(0.7),
                      outlineColor: Cesium.Color.BLACK,
                      outlineWidth: 2,
                      style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                      pixelOffset: new Cesium.Cartesian2(15, 0),
                      verticalOrigin: Cesium.VerticalOrigin.CENTER,
                      horizontalOrigin: Cesium.HorizontalOrigin.LEFT,
                      scale: 0.8,
                    },
                    billboard: {
                      image:
                        "data:image/svg+xml;base64," +
                        btoa(`
                                            <svg width="32" height="32" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                                                <circle cx="16" cy="16" r="8" fill="cyan" stroke="white" stroke-width="2"/>
                                            </svg>
                                        `),
                      verticalOrigin: Cesium.VerticalOrigin.CENTER,
                      scale: 0.8,
                    },
                  });

                  // åœ¨åœ†å¿ƒæ·»åŠ æ ‡æ³¨
                  viewer.entities.add({
                    position: centerPoint,
                    label: {
                      text: "åœ†å¿ƒ",
                      font: "12pt sans-serif",
                      fillColor: Cesium.Color.WHITE,
                      backgroundColor: Cesium.Color.BLACK.withAlpha(0.7),
                      outlineColor: Cesium.Color.BLACK,
                      outlineWidth: 1,
                      style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                      pixelOffset: new Cesium.Cartesian2(0, 20),
                      scale: 0.7,
                    },
                  });

                  // é‡ç½®çŠ¶æ€
                  resetDrawingState();
                  statusDiv.textContent = "çŠ¶æ€: åœ†å½¢ç»˜åˆ¶å®Œæˆ";
                  radiusInfoDiv.style.display = "none";
                }
              }
            }, Cesium.ScreenSpaceEventType.LEFT_DOWN);
          }
        }, Cesium.ScreenSpaceEventType.LEFT_DOWN);
      }

      // è®¡ç®—ä¸æ­£åŒ—çš„è§’åº¦ï¼ˆ0-360åº¦ï¼‰
      function calculateNorthAngle(center, point) {
        const centerCartographic = Cesium.Cartographic.fromCartesian(center);
        const pointCartographic = Cesium.Cartographic.fromCartesian(point);

        const centerLon = Cesium.Math.toDegrees(centerCartographic.longitude);
        const centerLat = Cesium.Math.toDegrees(centerCartographic.latitude);
        const pointLon = Cesium.Math.toDegrees(pointCartographic.longitude);
        const pointLat = Cesium.Math.toDegrees(pointCartographic.latitude);

        // è®¡ç®—ä¸¤ç‚¹é—´çš„æ–¹ä½è§’ï¼ˆä»æ­£åŒ—é¡ºæ—¶é’ˆï¼‰
        const dLon = ((pointLon - centerLon) * Math.PI) / 180;
        const y = Math.sin(dLon) * Math.cos((pointLat * Math.PI) / 180);
        const x =
          Math.cos((centerLat * Math.PI) / 180) * Math.sin((pointLat * Math.PI) / 180) -
          Math.sin((centerLat * Math.PI) / 180) * Math.cos((pointLat * Math.PI) / 180) * Math.cos(dLon);

        let angle = (Math.atan2(y, x) * 180) / Math.PI;
        angle = (angle + 360) % 360; // è½¬æ¢ä¸º0-360åº¦

        return angle;
      }

      // å–æ¶ˆç»˜åˆ¶
      function cancelDrawing() {
        resetDrawingState();
        statusDiv.textContent = "çŠ¶æ€: å·²å–æ¶ˆç»˜åˆ¶";
        radiusInfoDiv.style.display = "none";
      }

      // é‡ç½®ç»˜åˆ¶çŠ¶æ€
      function resetDrawingState() {
        drawingMode = false;
        drawCircleBtn.textContent = "å¼€å§‹ç»˜åˆ¶åœ†å½¢";
        drawCircleBtn.classList.remove("drawing-active");
        centerPoint = null;
        currentRadius = 0;
        mousePosition = null;

        if (temporaryCircle) {
          viewer.entities.remove(temporaryCircle);
          temporaryCircle = null;
        }

        if (radiusLine) {
          viewer.entities.remove(radiusLine);
          radiusLine = null;
        }

        if (handler) {
          handler.destroy();
          handler = null;
        }
      }

      // æ›´æ–°åŠå¾„çš„å›è°ƒå‡½æ•°
      function updateRadius() {
        return currentRadius;
      }

      // æ›´æ–°åŠå¾„çº¿çš„å›è°ƒå‡½æ•°
      function updateLinePositions() {
        if (centerPoint && mousePosition) {
          return [centerPoint, mousePosition];
        }
        return [centerPoint, centerPoint];
      }

      // æ·»åŠ ç¤ºä¾‹åœ†å½¢
      function addExampleCircle() {
        const exampleCenter = Cesium.Cartesian3.fromDegrees(104.0, 36.0, 0);
        const exampleRadius = 300000.0;
        const exampleEndPoint = Cesium.Cartesian3.fromDegrees(107.0, 36.0, 0); // æ­£ä¸œæ–¹å‘

        // ç¤ºä¾‹åœ†å½¢
        viewer.entities.add({
          position: exampleCenter,
          ellipse: {
            semiMinorAxis: exampleRadius,
            semiMajorAxis: exampleRadius,
            material: Cesium.Color.RED.withAlpha(0.3),
            outline: true,
            outlineColor: Cesium.Color.RED,
            outlineWidth: 2,
          },
          description: "ç¤ºä¾‹åœ†å½¢: åŠå¾„300å…¬é‡Œ",
        });

        // ç¤ºä¾‹åŠå¾„çº¿
        viewer.entities.add({
          polyline: {
            positions: [exampleCenter, exampleEndPoint],
            width: 2,
            material: Cesium.Color.ORANGE,
          },
        });

        // ç¤ºä¾‹æ ‡æ³¨
        viewer.entities.add({
          position: exampleEndPoint,
          label: {
            text: "åŠå¾„: 300.00 km\nè§’åº¦: 90.0Â°",
            font: "12pt sans-serif",
            fillColor: Cesium.Color.WHITE,
            backgroundColor: Cesium.Color.BLACK.withAlpha(0.7),
            outlineColor: Cesium.Color.BLACK,
            outlineWidth: 1,
            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
            pixelOffset: new Cesium.Cartesian2(15, 0),
            verticalOrigin: Cesium.VerticalOrigin.CENTER,
            horizontalOrigin: Cesium.HorizontalOrigin.LEFT,
            scale: 0.7,
          },
        });

        // æ·»åŠ æç¤ºä¿¡æ¯
        viewer.entities.add({
          position: Cesium.Cartesian3.fromDegrees(104.0, 41.0, 0),
          label: {
            text: "ç‚¹å‡»ä¸Šæ–¹å·¥å…·æ å¼€å§‹ç»˜åˆ¶åœ†å½¢",
            font: "14pt sans-serif",
            pixelOffset: new Cesium.Cartesian2(0, 50),
            fillColor: Cesium.Color.WHITE,
            outlineColor: Cesium.Color.BLACK,
            outlineWidth: 2,
            style: Cesium.LabelStyle.FILL_AND_OUTLINE,
          },
        });
      }

      // åˆå§‹åŒ–ç¤ºä¾‹
      addExampleCircle();
    </script>
  </body>
</html>
